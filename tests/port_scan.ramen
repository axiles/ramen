-- vim: ft=sql expandtab
-- Example program to detect DDoS and various scans from netflow data

-- Output the top 10 port scanners every hour (scans can be slow)
DEFINE new_cnxs AS
  FROM tests/fixtures/port_scan/csv
  WHEN not remember globally (0.1, first, 3600,
             hash (string(src) ||"-"|| string(dst)) +
             hash dst_port + hash ip_proto)
  SELECT src, dst;

DEFINE detect AS
  SELECT * FROM new_cnxs
  WHERE IS string(src) ||"-"|| string(dst) IN TOP 2
  EXPORT;
