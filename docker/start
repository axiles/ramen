#!/bin/bash

set -e

flags=()
gc_flags=()
archivist_flags=()
alerter_flags=()
httpd_flags=()
supervisor_flags=()

# Special argument to not load this stuff:

while test -n "$1" ; do case "$1" in
  (--debug)
    flags+=('--debug') ;
    shift ;;
  (--gc-*)
    gc_flags+=('--'$(echo $1 | cut -c 6-)) ;
    shift ;;
  (--archivist-*)
    archivist_flags+=('--'$(echo $1 | cut -c 13-)) ;
    shift ;;
  (--alerter-*)
    alerter_flags+=('--'$(echo $1 | cut -c 12-)) ;
    shift ;;
  (--httpd-*)
    httpd_flags+=('--'$(echo $1 | cut -c 9-)) ;
    shift ;;
  (--supervisor-*)
    supervisor_flags+=('--'$(echo $1 | cut -c 14-)) ;
    shift ;;
  (*)
    echo "Cannot parse $1" ;
    exit 1 ;;
esac ; done

OCAMLRUNPARAM=b
export OCAMLRUNPARAM

ulimit -v 2000000
nice ionice -c 2 ramen gc --stdout --loop ${flags[*]} ${gc_flags[*]} &
nice ionice -c 2 ramen archivist --stdout --loop ${flags[*]} ${archivist_flags[*]} &
nice ramen alerter --stdout ${flags[*]} ${alerter_flags[*]} &
ramen httpd --stdout --url=http://127.0.0.1:29380/ --graphite ${flags[*]} ${httpd_flags[*]} &
exec nice ramen supervisor --stdout ${flags[*]} ${supervisor_flags[*]}
