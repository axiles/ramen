-- vim: ft=sql expandtab
-- Simple program to test `ramen test`

DEFINE read AS
  -- There is no such file, the test suite will specify qps inputs
  READ FILES "/tmp/bidon.csv" (
    host STRING,
    time FLOAT,
    ip_client IP4,
    query STRING,
    response_time FLOAT?
  );

DEFINE qps AS
  SELECT MIN time AS time, SUM 1 AS qps
  FROM read
  GROUP BY host, u64(time)
  COMMIT AFTER in.time > out.time + 2;

DEFINE alert AS
  FROM qps WHERE qps <= 1 OR qps >= 10
  NOTIFY "ALERT!";
